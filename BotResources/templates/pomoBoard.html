<html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/pomoBoard.css') }}">

</html>

<body>
    <table class="table table-bordered table-striped table-responsive-stack" id="tableOne">
        <thead class="thead-dark"><th>{{tableTitle}}</th></thead>
        <tbody id="board" class="board">
        </tbody>
    </table>
    <div style="visibility: hidden">
        <table>
            <tr class="timer" id="timerTemplate">
                <td class="col1">
                    <span class="timeLeft">
                        Tick or timeLeft
                    </span>
                </td>
                <td class="col2">
                    <span class="username">
                        userDisplayName
                    </span>
                    <span class="work">
                        work
                    </span>
                    <span class="iterations">
                        (x of y)
                    </span>
                </td>
            </tr>
            <tr class="task" id="taskTemplate">
                <td class="col1">
                    <input class="done" type="checkbox" />
                </td>
                <td class="col2">
                    <span class="username">
                        userDisplayName
                    </span>
                    <span class="work">
                        work
                    </span>
                    <span class="timeTaken">
                        x
                    </span>
                </td>
            </tr>
        </table>
    </div>

    <script>
        $(function() {

            // Fetch the board
            function fetchBoard() {
                $.ajax({
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    url: "{{ url_for(dataPath, channel=channel) }}",
                    success: function(data) {
                        $("#board").empty();
                        try {
                            var jsonData = JSON.parse(data);
                        } catch (e) {
                            $("#board").append(data);
                            return;
                        }
                        jsonData.forEach(function(task, index, myArray) {
                            if (task.iterations !== undefined) {
                                let timerTemplate = document.getElementById(
                                    "timerTemplate");

                                var timerRow = timerTemplate.cloneNode(true);
                                timerRow.id = task.username

                                timerRow.querySelector(".timeLeft").textContent = Math
                                    .round((Date.parse(task
                                        .iterEndTime + 'Z') - new Date().getTime()) / 60 / 1000);

                                timerRow.querySelector(".username").textContent = task
                                    .userDisplayName;

                                if (task.workMode) {
                                    timerRow.querySelector(".work").textContent = task.work;
                                } else {
                                    timerRow.querySelector(".work").textContent = "relax!";
                                }

                                if (task.iterations > 1) {
                                    timerRow.querySelector(".iterations").textContent =
                                        "(" +
                                        task.currentIteration + " of " + task.iterations +
                                        " )";
                                } else {
                                    timerRow.querySelector(".iterations").textContent = "";
                                }

                                $("#board").append(timerRow);

                            } else {

                                let taskTemplate = document.getElementById("taskTemplate");

                                var taskRow = taskTemplate.cloneNode(true);

                                if (task.done) {
                                    taskRow.id = task.username+"_done_"+index;
                                    taskRow.className += " completed";
                                    taskRow.querySelector(".done").setAttribute('checked', true);
                                    taskRow.querySelector(".timeTaken").textContent = Math
                                        .round((Date.parse(task.endTime + 'Z') - Date.parse(
                                            task.startTime + 'Z')) / 60 / 1000);
                                } else {
                                    taskRow.querySelector(".timeTaken").textContent = "";
                                }

                                taskRow.querySelector(".username").textContent = task
                                    .userDisplayName;

                                taskRow.querySelector(".work").textContent = task.work;
                                $("#board").append(taskRow);
                            }
                        });
                    },
                    error: function(){
                        $("#board").append("Failed to get Data.\nPlease check if bot is working and data is valid");
                    }
                })
            }
            fetchBoard();
            setInterval(fetchBoard, 5000);


            // Automatic Scroll
            var direction = 'd';

            function scrollUpAndDown() {
                if (direction == 'd') {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                        direction = 'u';
                    } else {
                        window.scroll(0, window.pageYOffset + 5);
                    }
                } else {
                    if (window.pageYOffset == 0) {
                        direction = 'd';
                    } else {
                        window.scroll(0, window.pageYOffset - 5);
                    }
                }
            }
            setInterval(scrollUpAndDown, 100);
        });
    </script>
</body>